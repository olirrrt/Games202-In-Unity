



vscode装个live server，比原先那个http-server好用多了，再也不用费劲巴拉地刷新了，看webgl都眉清目秀了几分。不会写就反复横跳，一下就跳到作业三，不愧是我（叉腰

第一步，在延迟渲染的框架下，根据gbuffer里已有的深度、世界空间法线、世界坐标和albedo信息，计算直接光源贡献的漫反射光照。

* wo似乎没用

  ```glsl
  vec3 EvalDiffuse(vec3 wi, vec3 wo, vec2 uv) {
    vec3 N = normalize(GetGBufferNormalWorld(uv));
    vec3 albedo = GetGBufferDiffuse(uv);
    vec3 L = albedo * max(0.0, dot(N, wi)) * INV_PI;
    return L;
  }
  ```

第二步，用ray march的方法简单地实现ssr，为了方便debug，先用视线的反射向量采样，实现一个类似镜面反射。

一些实现上的细节（坑）： 

* 空间和深度值：世界空间+通过比较线性深度值来判断是否相交

* 采样步长和数量：如果步进在相机空间，则可以通过相机(far plane - near plane)/samples 得到步长,  步长数量直接影响画质，定步长会带来明显的条带状走样，抖动优化会带来噪音。

* ~~考虑天空盒？~~

* 习惯上为了方便计算，所谓“视线”是从世界坐标指向相机位置，和语义相反，实际求反射向量要记得取反😅。

  ```glsl
    vec3 V = normalize(uCameraPos - posWorld);
    vec3 R = normalize(reflect(-V, N));
  ```

* 出现类似z-fighting的噪音，注意浮点数精度。

  ```glsl
   if(z - depth > 1e-3){// hit 1e-6
   //if(z > depth){// wrong
  ```

* 观察到zoom in时反射平面边缘出现奇怪的类似clamp的现象，zoom out消失，这是因为射线步进到屏幕之外，无法从gbuffer里获得有效信息，所以需要判断屏幕坐标在范围之内或者改变纹理环绕方式，这也是屏幕空间系算法无法回避的问题。

  ```glsl
  vec2 uv = GetScreenCoordinate(pos);
  if(uv.x < 0.0 || uv.y < 0.0)  return false;
  ```

  而在视线较低时，平面上出现不该有的反射，猜测跟纹理分辨率有关，kd较小时直接clamp

  <img src="imgs\step2.png" style="zoom: 33%;" />

* mipmap优化

第三步，根据伪代码，用ssr实现间接光漫反射。漫反射在半球内随机采样，镜面反射需要根据lobe重要性采样。

<img src="imgs\pseudocode.png"  />

* 球面上生成的采样向量在切线空间内，需要转换到世界空间内。

  ```glsl
  vec3 tanToWorld(vec3 worldN, vec3 tanV){
    vec3 T, B;
    LocalBasis(worldN, T, B);
    mat3 TBN = mat3(normalize(T), normalize(B), worldN);
    return normalize(TBN * tanV);
  }
  ```

* 随机数使用？

  ```glsl
      //float seed = float(i); 每个采样点生成一个seed,不会有噪音
      //float r = Rand1(seed);
  	Rand1(s);
  ```

* pdf采样概率，为啥每一项都要乘po/pdf

  ```glsl
        L += EvalDiffuse(dir, vec3(0.), uv0) / pdfs[i] * EvalDiffuse(uLightDir, vec3(0.), uv) * EvalDirectionalLight(uv);
  
  ```

  

* 光源对交点的贡献，等于交点的辐照度，即交点作为间接光源影响render point

* 不需要考虑光线在传播过程中的衰减和可见性？

* ~~出现了类似SSAO、远距离处出现不该出现的间接光~~

* 黑边

  <center><img src="imgs\step1.png" style="zoom:33%;" /><img src="imgs\step3.png" style="zoom:33%;" /></center>





🦄

glsl https://registry.khronos.org/OpenGL/specs/gl/GLSLangSpec.4.30.pdf#page=35

https://advances.realtimerendering.com/s2015/index.html